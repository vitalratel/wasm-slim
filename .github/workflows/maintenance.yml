name: Scheduled Maintenance

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual trigger

# Limit concurrency to prevent overlap
concurrency:
  group: maintenance
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  dependency-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit --deny warnings

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”’ Security Advisory Detected';
            const body = `Security vulnerabilities were detected in dependencies.\n\nWorkflow: ${context.workflow}\nRun: ${context.runId}\n\nPlease run \`cargo audit\` locally and update affected dependencies.`;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
            }

  dependency-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked

      - name: Check for outdated dependencies
        id: outdated
        run: |
          echo "## Outdated Dependencies" > outdated.txt
          cargo outdated --format json > outdated.json || true
          
          # Parse and format output
          if [ -s outdated.json ]; then
            echo "Found outdated dependencies" >> outdated.txt
            cat outdated.json >> outdated.txt
          else
            echo "All dependencies are up to date! âœ…" >> outdated.txt
          fi

      - name: Create issue for major updates
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = fs.readFileSync('outdated.txt', 'utf8');
            
            // Only create issue if there are actual updates
            if (!outdated.includes('up to date')) {
              const title = 'ðŸ“¦ Dependency Updates Available';
              const body = `Outdated dependencies were detected during scheduled maintenance.\n\n${outdated}\n\nWorkflow: ${context.workflow}\nRun: ${context.runId}\n\nConsider updating dependencies with \`cargo update\`.`;
              
              // Check if issue already exists
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependencies'
              });
              
              const existingIssue = issues.data.find(issue => issue.title === title);
              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['dependencies', 'maintenance', 'automated']
                });
              }
            }

  coverage-check:
    name: Coverage Regression Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Run coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(cargo llvm-cov --all-features --workspace --summary-only | grep -oP '\d+\.\d+(?=%)')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=80.0
          
          # Use awk for floating point comparison
          if awk "BEGIN {exit !($COVERAGE < $THRESHOLD)}"; then
            echo "âŒ Coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
            exit 1
          else
            echo "âœ… Coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
          fi

      - name: Create issue on coverage regression
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const title = 'ðŸ“‰ Coverage Regression Detected';
            const body = `Code coverage has dropped below the 80% threshold.\n\nCurrent: ${coverage}%\nThreshold: 80%\n\nWorkflow: ${context.workflow}\nRun: ${context.runId}\n\nPlease add tests to restore coverage.`;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'coverage'
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['coverage', 'quality', 'automated']
              });
            }

  benchmark-stability:
    name: Benchmark Stability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: cargo bench --no-fail-fast -- --output-format bencher | tee bench-output.txt

      - name: Check for benchmark regressions
        run: |
          # Parse benchmark output for any significant changes
          # This is a basic check - you could enhance with historical comparison
          if grep -q "change:.*[+][0-9][0-9]%" bench-output.txt; then
            echo "âš ï¸  Potential performance regression detected (>10% slower)"
            # Don't fail, just warn
          else
            echo "âœ… No significant performance regressions detected"
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: bench-output.txt
          retention-days: 30

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-license
        run: cargo install cargo-license --locked

      - name: Check licenses
        run: |
          cargo license --json > licenses.json
          
          # Check for any copyleft or unknown licenses
          if grep -qi "GPL\|AGPL\|unknown" licenses.json; then
            echo "âš ï¸  Found potentially problematic licenses"
            cargo license
            exit 1
          else
            echo "âœ… All licenses are compatible"
          fi

      - name: Create issue on license problems
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'âš–ï¸  License Compliance Issue';
            const body = `Potentially problematic licenses were detected.\n\nWorkflow: ${context.workflow}\nRun: ${context.runId}\n\nPlease review dependencies for GPL, AGPL, or unknown licenses.`;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'legal'
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['legal', 'dependencies', 'automated']
              });
            }

  msrv-check:
    name: MSRV Compatibility Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract MSRV from Cargo.toml
        id: msrv
        run: |
          MSRV=$(grep -oP 'rust-version\s*=\s*"\K[^"]+' Cargo.toml)
          echo "version=$MSRV" >> $GITHUB_OUTPUT
          echo "MSRV: $MSRV"

      - name: Setup Rust MSRV
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ steps.msrv.outputs.version }}

      - name: Cache cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-msrv-${{ hashFiles('**/Cargo.lock') }}

      - name: Check MSRV compatibility
        run: cargo check --all-features

      - name: Create issue on MSRV breakage
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const msrv = '${{ steps.msrv.outputs.version }}';
            const title = 'ðŸ¦€ MSRV Compatibility Broken';
            const body = `Code no longer compiles with MSRV ${msrv}.\n\nWorkflow: ${context.workflow}\nRun: ${context.runId}\n\nEither fix the code or update MSRV in Cargo.toml.`;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'compatibility'
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['compatibility', 'rust', 'automated']
              });
            }

  summary:
    name: Maintenance Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, dependency-updates, coverage-check, benchmark-stability, license-compliance, msrv-check]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”§ Scheduled Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Updates | ${{ needs.dependency-updates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Check | ${{ needs.coverage-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark Stability | ${{ needs.benchmark-stability.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MSRV Compatibility | ${{ needs.msrv-check.result }} |" >> $GITHUB_STEP_SUMMARY
