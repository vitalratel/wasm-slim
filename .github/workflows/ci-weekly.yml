# ABOUTME: Weekly CI workflow for expensive/thorough checks
# ABOUTME: Includes cross-platform tests, MSRV, coverage, minimal versions

name: CI Weekly

on:
  schedule:
    # Weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Cross-platform tests (macOS/Windows are expensive)
  cross-platform:
    name: Cross-Platform (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          targets: wasm32-unknown-unknown

      - name: Install tools
        uses: taiki-e/install-action@v2
        with:
          tool: twiggy,wasm-bindgen-cli@0.2.108

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.rust }}

      - name: Run tests
        run: cargo test --workspace --verbose

  # MSRV compatibility check
  msrv:
    name: MSRV Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Extract MSRV from Cargo.toml
        id: msrv
        run: |
          MSRV=$(grep -oP 'rust-version\s*=\s*"\K[^"]+' Cargo.toml || echo "1.70")
          echo "version=$MSRV" >> $GITHUB_OUTPUT
          echo "MSRV: $MSRV"

      - name: Install Rust MSRV
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ steps.msrv.outputs.version }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: msrv-${{ steps.msrv.outputs.version }}

      - name: Check MSRV compatibility
        run: cargo check --all-features

  # Minimal versions check (ensure we don't accidentally require newer deps)
  minimal-versions:
    name: Minimal Versions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: minimal-versions

      - name: Check with minimal versions
        run: |
          rm -rf ~/.cargo/registry/src
          cargo +nightly update -Z minimal-versions
          cargo +nightly check --all-features

  # Coverage check with threshold
  coverage:
    name: Coverage Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
          components: llvm-tools-preview

      - name: Install tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,twiggy,wasm-bindgen-cli@0.2.108

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run coverage and check threshold
        run: |
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

          # Extract percentage from lcov file
          COVERAGE=$(cargo llvm-cov report --summary-only 2>/dev/null | grep -oP '\d+\.\d+(?=%)' | tail -1)
          echo "Coverage: $COVERAGE%"

          THRESHOLD=70.0
          if awk "BEGIN {exit !($COVERAGE < $THRESHOLD)}"; then
            echo "âŒ Coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
            exit 1
          else
            echo "âœ… Coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: lcov.info
          retention-days: 30

  # Summary
  summary:
    name: Weekly Summary
    runs-on: ubuntu-latest
    needs: [cross-platform, msrv, minimal-versions, coverage]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”§ Weekly CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-Platform | ${{ needs.cross-platform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MSRV | ${{ needs.msrv.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Minimal Versions | ${{ needs.minimal-versions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
